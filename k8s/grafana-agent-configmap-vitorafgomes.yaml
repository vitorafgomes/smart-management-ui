apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-agent-config
  namespace: monitoring
data:
  agent.yaml: |
    server:
      log:
        level: info

    # Configuração do Faro Receiver
    traces:
      configs:
        - name: default
          receivers:
            # Receiver OTLP para receber traces do Faro
            otlp:
              protocols:
                http:
                  endpoint: 0.0.0.0:4318
                grpc:
                  endpoint: 0.0.0.0:4317
          remote_write:
            # Enviar para Grafana Tempo (descoberto via kubectl)
            # Service: tempo.monitoring.svc.cluster.local
            # Porta OTLP gRPC: 4317
            - endpoint: tempo.monitoring.svc.cluster.local:4317
              insecure: true
          # Batch processor para otimizar envio
          batch:
            timeout: 5s
            send_batch_size: 100

    # Configuração do Logs (Loki)
    logs:
      configs:
        - name: default
          clients:
            # Enviar logs para Grafana Loki (descoberto via kubectl)
            # Service: loki.monitoring.svc.cluster.local
            # Porta: 3100
            - url: http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push
          positions:
            filename: /tmp/positions.yaml

    # Integração Faro
    integrations:
      faro_receiver:
        # Endpoint onde o Faro Web SDK enviará os dados
        receiver:
          protocols:
            http:
              endpoint: 0.0.0.0:12347
              # Configurar CORS para seu domínio
              cors:
                allowed_origins:
                  - "https://vitorafgomes.net"
                  - "https://www.vitorafgomes.net"
                  - "https://*.vitorafgomes.net"
                  - "http://localhost:4200"  # Para desenvolvimento local
                allowed_headers:
                  - "*"
                allowed_methods:
                  - "POST"
                  - "GET"
                  - "OPTIONS"
                max_age: 7200
        # Processar e rotear dados do Faro
        logs:
          # Logs serão enviados para Loki
          send_to_loki: true
        traces:
          # Traces serão enviados para Tempo
          send_to_tempo: true

---
# Nota: Métricas do Faro (Web Vitals) não serão enviadas para Prometheus
# pois o kps-kube-prometheus-stack-prometheus não tem remote_write habilitado.
# Para habilitar, você precisaria configurar remote_write no Prometheus.
# Alternativamente, as métricas ficam disponíveis nos logs do Loki.